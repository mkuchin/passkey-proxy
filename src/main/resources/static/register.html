<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Register Passkey</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #f5f5f5;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.10);
    padding: 2.5rem 2rem;
    width: 100%;
    max-width: 440px;
  }
  h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #111; }
  .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; }
  label { display: block; font-size: 0.85rem; color: #555; margin-bottom: 0.25rem; }
  input[type=text] {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    margin-bottom: 1rem;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type=text]:focus { border-color: #4f46e5; }
  button {
    width: 100%;
    padding: 0.75rem;
    background: #059669;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #047857; }
  button:disabled { background: #6ee7b7; cursor: not-allowed; }
  .msg { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem; display: none; }
  .msg.error { background: #fee2e2; color: #b91c1c; display: block; }
  .msg.success { background: #d1fae5; color: #065f46; display: block; }
  .credential-box {
    margin-top: 1rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    font-family: monospace;
    font-size: 0.78rem;
    word-break: break-all;
    white-space: pre-wrap;
    display: none;
  }
  .links { margin-top: 1.25rem; text-align: center; font-size: 0.85rem; color: #666; }
  .links a { color: #4f46e5; text-decoration: none; }
  .links a:hover { text-decoration: underline; }
</style>
</head>
<body>
<div class="card">
  <h1>ðŸ“± Register passkey</h1>
  <p class="subtitle">
    Create a new passkey and share the credential with your administrator to activate your account.
  </p>
  <label for="username">Username</label>
  <input type="text" id="username" autocomplete="username" placeholder="alice" autofocus>
  <button id="registerBtn" onclick="register()">Register passkey</button>
  <div id="msg" class="msg"></div>
  <div id="credentialBox" class="credential-box"></div>
  <div class="links">
    <a href="/webauthn/login">Back to login</a>
  </div>
</div>

<script>
  function b64url(bytes) {
    return btoa(String.fromCharCode(...new Uint8Array(bytes)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  }
  function fromB64url(str) {
    const b64 = str.replace(/-/g, '+').replace(/_/g, '/');
    return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  }
  function showError(msg) {
    const el = document.getElementById('msg');
    el.className = 'msg error';
    el.textContent = msg;
    document.getElementById('credentialBox').style.display = 'none';
  }
  function showSuccess(msg, data) {
    const el = document.getElementById('msg');
    el.className = 'msg success';
    el.textContent = msg;
    if (data) {
      const box = document.getElementById('credentialBox');
      box.textContent = data;
      box.style.display = 'block';
    }
  }

  // Pre-fill username from query param
  const params = new URLSearchParams(window.location.search);
  if (params.get('username')) document.getElementById('username').value = params.get('username');

  document.getElementById('username').addEventListener('keydown', e => {
    if (e.key === 'Enter') register();
  });

  async function register() {
    const username = document.getElementById('username').value.trim();
    if (!username) { showError('Enter your username'); return; }

    const btn = document.getElementById('registerBtn');
    btn.disabled = true;
    btn.textContent = 'Waiting for passkeyâ€¦';

    try {
      // Step 1 â€“ get creation options
      const optRes = await fetch(
        '/webauthn/register/get_credential_creation_options?username=' + encodeURIComponent(username));
      const optData = await optRes.json();
      if (!optRes.ok) { showError(optData.message || 'Registration failed'); return; }

      const options = optData.publicKey;
      options.challenge = fromB64url(options.challenge);
      options.user.id  = fromB64url(options.user.id);
      if (options.excludeCredentials) {
        options.excludeCredentials = options.excludeCredentials.map(c => ({
          ...c, id: fromB64url(c.id)
        }));
      }

      // Step 2 â€“ create credential in browser
      const credential = await navigator.credentials.create({ publicKey: options });

      // Step 3 â€“ send attestation to server
      const transports = credential.response.getTransports
        ? credential.response.getTransports() : [];

      const payload = {
        id:    credential.id,
        rawId: b64url(credential.rawId),
        response: {
          clientDataJSON:    b64url(credential.response.clientDataJSON),
          attestationObject: b64url(credential.response.attestationObject),
          transports,
        },
        clientExtensionResults: credential.getClientExtensionResults
          ? credential.getClientExtensionResults() : {},
        type: credential.type,
      };

      const regRes = await fetch(
        '/webauthn/register/process_registration_attestation?username=' + encodeURIComponent(username), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
      const regData = await regRes.json();

      if (regRes.ok) {
        showSuccess(regData.message, regData.data);
      } else {
        showError(regData.message || 'Registration failed');
      }
    } catch (err) {
      if (err.name === 'NotAllowedError') {
        showError('Passkey prompt was dismissed or timed out.');
      } else if (err.name === 'InvalidStateError') {
        showError('This passkey is already registered.');
      } else {
        showError('Error: ' + err.message);
      }
    } finally {
      btn.disabled = false;
      btn.textContent = 'Register passkey';
    }
  }
</script>
</body>
</html>
